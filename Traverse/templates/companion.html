{% extends 'Dashboardbase.html' %}
{% load static %}
{% block content %}

<div align="start">
  <hr>
</div>
<div id="Map">
</div>
<input type="hidden" id="image_url" name="image_url" value="{{request.user.orofile.profile_pic.url}}">
 <div class="d-flex flex-lg-row flex-column-reverse g-2">
  <div class="flex-grow-1" id="map" style="width: 100%; height: 400px; border-radius: 10px;"> 
  </div>
  <div class="mx-4 flex-grow-1">
    <h6>Legends</h6>
    <hr>
    <div class="d-flex my-3">
      <div class="p-1 bg-info" style="width: 20px; height: 20px; border-radius: 50%; opacity: 0.5;"></div>
      <p class="p-0 m-0 mx-2 text-sm">5km</p>
      <div class="p-1 bg-warning legendlg ms-6" style="width: 20px; height: 20px; border-radius: 50%; opacity: 0.5;"></div>
      <p class="p-0 m-0 mx-2 text-sm legendlg">10km</p>
    </div>
    <div class="d-flex legend my-3">
      <div class="p-1 bg-warning legend" style="width: 20px; height: 20px; border-radius: 50%; opacity: 0.5;"></div>
      <p class="p-0 m-0 mx-2 text-sm legend">10km</p>
    </div>
  </div>
</div>  


</div>
<style>
 

  .info-window {
    background-color: white;
    color: #333;
    font-size: 12px;
    padding: 10px;
    width: 200px;
  }
  
  .place-name {
    font-size: 14px;
    margin: 0;
  }
  
  .details {
    list-style: none;
    margin: 0;
    padding: 0;
  }
  
  .details li {
    margin-bottom: 5px;
  }

  .info-window .map-link {
    display: block;
    margin-top: 10px;
    border-top: 1px solid #ccc;
    padding-top: 10px;
  }
  
  .marker-hovered {
    transform: rotate(360deg) scale(1.2);
    transition: transform 0.2s ease-in-out;
  }
  
  .marker-hovered:hover {
    transform: rotate(360deg) scale(1.3);
  }
 
  @media (max-width: 992px) {
   h1{
     font-size: 30px;
    }
    .flex-lg-row {
      flex-direction: column-reverse;
    }
    .flex-grow-1 {
      flex-grow: 1;
    }
    .legend{
      display:none
    }
  }
@media(min-width:992px)
{
  .legendlg{
    display:none
  }
}
</style>

<script>

  function getRoundedImage(url, size) {
    return new Promise(resolve => {
      const img = new Image();
      img.onload = function () {
        const canvas = document.createElement('canvas');
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext('2d');
        ctx.beginPath();
        ctx.arc(size / 2, size / 2, size / 2, 0, Math.PI * 2, true);
        ctx.closePath();
        ctx.clip();
        ctx.drawImage(img, 0, 0, img.width, img.height, 0, 0, size, size);
        resolve(canvas.toDataURL());
      };
      img.src = url;
    });
  }

  function getLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(showPosition);
    } else {
      console.log("Geolocation is not supported by this browser.");
    }
  }

  function showPosition(position) {
    $.ajax({
      url: 'companion/location',
      type: 'POST',
      data: {
        'latitude': position.coords.latitude,
        'longitude': position.coords.longitude,
        'csrfmiddlewaretoken': '{{ csrf_token }}'
      },
      success: function (response) {
        initMap(position)
      }
    });
  }

  function initMap(position) {
    const myLoc = { lat: position.coords.latitude, lng: position.coords.longitude }
    const locations = JSON.parse("{{points|escapejs}}");
    const destination_locations = JSON.parse("{{destination_points|escapejs}}");
    const map = new google.maps.Map(document.getElementById('map'), {
      zoom: 10,
      center: myLoc
    })

    destination_locations.forEach((loc) => {
      const marker = new google.maps.Marker({
        position: { lat: parseFloat(loc[1]), lng: parseFloat(loc[0]) },
        animation: google.maps.Animation.DROP,
        map: map,
        icon: {
          url: '/static/images/d_loc_pin2.png',
          scaledSize: new google.maps.Size(32, 32),
        },
      });
    
      const contentString = `
      <div class="info-window">
        <h2 class="place-name">${loc[2]}</h2>
        <ul class="details">
          <li>Start Date: ${loc[3]}</li>
          <li>End Date: ${loc[4]}</li>
          <li>Latitude: ${loc[1]}</li>
          <li>Longitude: ${loc[0]}</li>
          <li><a href="https://www.google.com/maps/search/?api=1&query=${loc[1]},${loc[0]}" target="_blank" class="map-link">View on Google Maps</a></li>
        </ul>
      </div>
    `;
    
    
      const infowindow = new google.maps.InfoWindow({
        content: contentString,
      });
      
      marker.addListener("mouseover", () => {
        marker.getIcon().classList.add("marker-hovered");
      });
    
      marker.addListener("mouseout", () => {
        marker.getIcon().classList.remove("marker-hovered");
      });

      marker.addListener('click', () => {
        infowindow.open(map, marker);
      });
    
      map.addListener('click', () => {
        if (infowindow && infowindow.getMap()) {
          infowindow.close();
        }
      });
    });
    
    
      

    const createInfoWindowContent = (location) => {
      const mediaPath = "/media/";
      const imagePath = `${mediaPath}${location.profile_pic}`;
      const userName = location.username;

      let bio = location.bio;
      if (location.bio == '') {
        bio = 'No Bio';
      }
      const chatLink = `/dashboard/chat/person-chat?username=${userName}`;
    
      return `
        <div style="min-width: 150px; overflow: hidden;">
          <div style="display: flex;" class='m-0 p-0'>
            <img src="${imagePath}" width="32" height="32" style="border-radius: 25px; margin-top: 5px;">
            <div style="margin-left: 10px;">
              <p class='p-0 m-0' style="font-size: 15px; color: gray;">${userName}</p>
              <p class="p-0 m-0" style="font-size: 12px; color: gray;">Lat: ${location.location_latit} | Long: ${location.location_longi} </p>
            </div>
          </div>
          <p style="font-size: 12px; color: gray;">${bio}</p>
          <div class='d-flex'>
            <a href="${chatLink}" class="btn btn-info p-2 w-100 m-0 mx-1">Chat</a>
            <a href="/dashboard/friends/add_friend/${location.user_id}/add" class="btn btn-success p-2 w-100 m-0 mx-1">Add</a>
          </div>
        </div>
      `;
    };

    async function setMapMarker(imageUrl, settingmarker) {
      const roundedImageUrl = await getRoundedImage(imageUrl, 42);

      settingmarker.setIcon({
        url: roundedImageUrl,
        scaledSize: new google.maps.Size(50, 50),
        origin: new google.maps.Point(0, 0),
        anchor: new google.maps.Point(25, 25)
      });
    }

    locations.forEach((location) => {
      const infoWindowContent = createInfoWindowContent(location);

      const infoWindow = new google.maps.InfoWindow({
        content: infoWindowContent,
      });

      const loopmarker = new google.maps.Marker({
        position: { lat: parseFloat(location.location_latit), lng: parseFloat(location.location_longi) },
        animation: google.maps.Animation.DROP,
        map: map,
        title: location.username,
      });
      setMapMarker('/media/' + location.profile_pic, loopmarker)

      loopmarker.addListener('click', () => {
        infoWindow.open(map, loopmarker);
      });
    });

    const mediaPath = "/media/";
    const imagePath = `
    {% if request.user.profile.profile_pic %}
    {{request.user.profile.profile_pic.url}}
    {% else %}
    /media/profile_pics/default.jpg
    {% endif %}
      `;
    const userName = '{{request.user.username}}';
    let bio = "{{request.user.profile.bio}}";
    if (location.bio == '') {
      bio = 'No Bio';
    }

    const MyinfoWindow = new google.maps.InfoWindow({
      content: `
      <div style="min-width: 150px; overflow: hidden;">
        <div style="display: flex;" class='m-0 p-0'>
          <img src="${imagePath}" width="32" height="32" style="border-radius: 25px; margin-top: 5px;">
          <div style="margin-left: 10px;">
            <p class='p-0 m-0' style="font-size: 15px; color: gray;">${userName}</p>
            <p class="p-0 m-0" style="font-size: 12px; color: gray;">Lat: {{request.user.profile.location_latit|truncatechars:7}} | Long: {{request.user.profile.location_longi|truncatechars:7}} </p>
          </div>
        </div>
        <p style="font-size: 12px; color: gray;">${bio}</p>
        <div class='d-flex'>
          <a href="/dashboard/profile" class="btn btn-info p-2 w-100 m-0 mx-1">Profile</a>
        </div>
      </div>
      `
    });

    // Create the marker
    const marker = new google.maps.Marker({
      position: myLoc,
      map: map
    });

    setMapMarker('{% if request.user.profile.profile_pic %}{{request.user.profile.profile_pic.url}}{% else %}/media/profile_pics/default.jpg{% endif %}', marker)

    marker.set('label', {
      text: '',
      color: 'transparent'
    });

    marker.addListener('click', () => {
      MyinfoWindow.open(map, marker);
    });

    const cityCircleOptions = {
      strokeColor: "transparent",
      strokeOpacity: 0,
      strokeWeight: 0.1,
      fillOpacity: 0.2,
      map: map,
      center: myLoc,
    };

    const cityCircle1 = new google.maps.Circle({
      ...cityCircleOptions,
      fillColor: "#4842c7",
      radius: 5000, // 5km
    });
    cityCircle1.bindTo("center", marker, "position");

    const cityCircle2 = new google.maps.Circle({
      ...cityCircleOptions,
      fillColor: "#c79042",
      radius: 10000, // 10 km
    });

    cityCircle2.bindTo("center", marker, "position");

  }
</script>

<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAxaPlVxe-HTnuBzPajIUoXQSxiqoMitLc&callback=getLocation"></script>
{% endblock %}