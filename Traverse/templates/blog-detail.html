{% extends 'Dashboardbase.html' %}


{% block content %}

<div class="container-fluid">
    <div class="row">
        <div class="col-md-8">
            <div class="d-flex justify-content-between align-items-center">
                <h3>{{ blog.title }}</h3>
                {% if request.user == blog.author %}
                
                <div class="dropdown">
                    <button class="btn mt-3 " data-bs-toggle="dropdown"><i class="fa fa-bars text-lg"
                            aria-hidden="true"></i></button>
                    <ul class="dropdown-menu">
                        <li><button class="dropdown-item" data-bs-toggle="modal" data-bs-target="#editModal"><i
                                    class="fa fa-edit text-info" aria-hidden="true"></i>
                                Edit</button></li>
                        <li><button class="dropdown-item" data-bs-toggle="modal" data-bs-target="#deleteModel"><i
                                    class="fa fa-trash text-danger text-info" aria-hidden="true">
                                </i> Delete</button></li>
                        </li>
                    </ul>
                </div>
                {% endif %}
            </div>
            <div class="author align-items-center">
                {% if blog.author.profile.profile_pic %}
                <div class="avatar shadow"
                    style="background-image: url('{{ blog.author.profile.profile_pic.url }}'); border-radius: 50%; background-size: cover;">
                </div>
                {% else %}
                <div class="avatar shadow"
                    style="background-image: url('/media/profile_pics/default.jpg'); border-radius: 50%; background-size: cover;">
                </div>
                {% endif %}
                <div class="d-flex justify-content-between align-items-center">
                    <div class="name p-2 flex-grow-3">
                        <span class="text-capitalize">{{blog.author}}</span>
                        <div class="stats">
                            <small>Posted on {{blog.pub_date|date:"M d, Y"}}</small>
                        </div>
                    </div>
                </div>
            </div>
            <hr>
            <p>{{ blog.description }}</p>
            <hr>
            <div class="container-fluid d-flex justify-content-between">
                <div></div>
                <div style="display: flex; gap: 10px;">
                    <i class="fa fa-heart-o" style="font-size: 1.5rem;" id="like_button"></i>
                    <p id="num_likes">{{blog.likes.count}}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <img class="blog-image mt-md-9 mt-sm-4" style="height: style="height: 300px; width:250px"" src="{{blog.image.url}}" alt="">
        </div>
    </div>
</div>
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Edit Blog</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <form method="post" enctype="multipart/form-data" id="edit_form">
                    {% csrf_token %}
                    {{form.as_p}}
                    <input type="text" name="type" value="edit" hidden>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" id="save" class="btn btn-primary">Save changes</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="deleteModel" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Delete Blog</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <form method="post" enctype="multipart/form-data" id="delete_form">
                    {% csrf_token %}
                    Do You want To Delete The Blog?
                    <input type="text" name="type" value="delete" hidden>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" id="delete" class="btn btn-danger">Save changes</button>
            </div>
        </div>
    </div>
</div>
<style>
    .blog-image {
        width: 100%;
        height: 400px;
        border-radius: 20px;
    }

    #like_button {
        transition: 0.3s;
        cursor: pointer;
        color: rgb(225, 77, 77);
    }

    #num_likes {
        transition: 0.3s;
    }
</style>
<script>
    document.getElementById('save').addEventListener('click', function () {
        document.getElementById('edit_form').submit();
    })
    document.getElementById('delete').addEventListener('click', function () {
        document.getElementById('delete_form').submit();
    })
    const btn = document.getElementById('like_button')
    const likes = document.getElementById('num_likes')
    btn.addEventListener('click', function () {
        likePost('{{blog.id}}')
    })
    function likePost(postId) {
        fetch('{% url "like_post" blog.id 0 %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ id: postId, status: 0 })
        })
            .then(response => response.json())
            .then(data => {
                document.getElementById('num_likes').innerText = data.likes_count;
                if (data.status === true) {
                    btn.classList.add('fa-heart')
                    btn.classList.remove('fa-heart-o')
                } else {
                    btn.classList.add('fa-heart-o')
                    btn.classList.remove('fa-heart')
                }
            });
    }
    function isThisBlogLikedByNUser(postId) {
        fetch('{% url "like_post" blog.id 1 %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ id: postId, status: 1 })
        })
            .then(response => response.json())
            .then(data => {
                if (data.liked == true) {
                    btn.classList.add('fa-heart')
                    btn.classList.remove('fa-heart-o')
                } else {
                    btn.classList.add('fa-heart-o')
                    btn.classList.remove('fa-heart')
                }
            });
    }
    isThisBlogLikedByNUser('{{blog.id}}')
</script>
{% endblock content %}